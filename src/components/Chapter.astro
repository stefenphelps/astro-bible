---
interface Props {
	translation: string;
	book: string;
	chapterNumber: string;
	verses: Record<string, string>;
}

const { translation, book, chapterNumber, verses } = Astro.props;
const entries = Object.entries(verses); // [["1", "In the beginning..."], ["2", "The earth..."], ...]
---
<section class='chapter' id={`chapter-${chapterNumber}`}>
	<h2>Chapter {chapterNumber}</h2>
	<nav>
		<ul>
			{entries.map(([verseNum], index) => (
				<>
				{index % 10 === 0 && (
					<li>
						<a href={`#chapter-${chapterNumber}-verse-${verseNum}`}>
							{verseNum}-{parseInt(verseNum) + 9 > entries.length ? entries.length : parseInt(verseNum) + 9}
						</a>
					</li>
				)}
				</>
			))}
		</ul>
	</nav>
	{entries.map(([verseNum, text], index) => (
		<p
			id={`chapter-${chapterNumber}-verse-${verseNum}`}
			tabindex="0"
			data-book={book}
			data-chapter={chapterNumber}
			data-verse={verseNum}
			data-translation={translation}
		>
			{verseNum !== "1" && <sup>{verseNum}&nbsp;</sup>}
			<span>{text}</span>
		</p>
	))}
</section>

<script>
import Snackbar from "node-snackbar";
import slugify from "slugify";

window.addEventListener("DOMContentLoaded", () => {
	if (window.__verseHighlightInit) {
		return;
	}
	window.__verseHighlightInit = true;

	const verses = document.querySelectorAll(".chapter p");
	const versesArray = Array.from(verses);
	if (versesArray.length === 0) {
		return;
	}

	const firstVerse = versesArray[0];
	const book = firstVerse.dataset.book || "Book";
	const translation = firstVerse.dataset.translation || "esv";
	const bookSlug = slugify(book, { lower: true });
	const storageKey = `highlighted:${translation}:${bookSlug}`;

	const loadHighlights = () => {
		try {
			return JSON.parse(localStorage.getItem(storageKey) || "[]");
		} catch (error) {
			return [];
		}
	};

	const saveHighlights = (ids) => {
		localStorage.setItem(storageKey, JSON.stringify(ids));
	};

	let highlightedIds = loadHighlights();

	const applyHighlights = () => {
		versesArray.forEach((verse) => {
			verse.classList.toggle("highlighted", highlightedIds.includes(verse.id));
		});
	};

	const getHighlightedVerses = () =>
		versesArray.filter((verse) => verse.classList.contains("highlighted"));

	const ensureShareButton = () => {
		let shareButton = document.querySelector(".share-highlights");
		if (shareButton) {
			return shareButton;
		}

		shareButton = document.createElement("button");
		shareButton.className = "share-highlights";
		shareButton.type = "button";
		shareButton.setAttribute("aria-label", "Share highlighted verses");
		shareButton.innerHTML = `
			<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" width="18" height="18" aria-hidden="true">
				<path fill="currentColor" d="M307 34.8c-11.5 5.5-19 17.2-19 30.6l0 96-112 0c-61.9 0-112 50.1-112 112c0 40.8 21.8 76.5 54.5 96c7.8 4.7 17.8 5.6 26.3 2.6s14.6-9.8 16.1-18.6c.2-1.3.4-2.6.6-3.9c2-12.6 .1-25.4-7.4-35.6C147.3 304.6 144 295 144 284.5c0-26 22.1-47 49.5-47l94.5 0 0 96c0 13.4 7.7 25.1 19 30.6s25.5 3.8 35-4.4l128-112c6.9-6 10.9-14.6 10.9-23.7s-4-17.7-10.9-23.7l-128-112c-9.5-8.3-23.6-9.9-35-4.4zM0 416c0 53 43 96 96 96l320 0c53 0 96-43 96-96l0-32c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 32c0 17.7-14.3 32-32 32l-320 0c-17.7 0-32-14.3-32-32l0-32c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 32z"/></path>
			</svg>
		`;
		document.body.appendChild(shareButton);
		return shareButton;
	};

	const shareButton = ensureShareButton();

	const updateShareButton = () => {
		const highlighted = getHighlightedVerses();
		shareButton.hidden = highlighted.length === 0;
	};

	shareButton.addEventListener("click", async () => {
		const highlighted = getHighlightedVerses();
		if (highlighted.length === 0) {
			return;
		}

		const versesText = highlighted
			.map((verse) => {
				const chapter = verse.dataset.chapter;
				const verseNum = verse.dataset.verse;
				const text = verse.querySelector("span")?.textContent ?? "";
				return `${book} ${chapter}:${verseNum} ${text}`;
			})
			.join("\n\n");

		const shareData = {
			title: `${book} Highlights`,
			text: versesText,
			url: window.location.href,
		};

		try {
			if (navigator.share) {
				await navigator.share(shareData);
				Snackbar.show({
					actionTextColor: "var(--accent)",
					text: "Highlights shared successfully.",
				});
				return;
			}
			await navigator.clipboard.writeText(versesText);
			Snackbar.show({
				actionTextColor: "var(--accent)",
				text: "Copied highlights to clipboard.",
			});
		} catch (error) {
			if (error?.name === "AbortError") {
				return;
			}
			try {
				await navigator.clipboard.writeText(versesText);
				Snackbar.show({
					actionTextColor: "var(--accent)",
					text: "Copied highlights to clipboard.",
				});
			} catch (clipboardError) {
				console.error("Sharing failed:", clipboardError);
			}
		}
	});

	applyHighlights();
	updateShareButton();

	versesArray.forEach((verse) => {
		verse.addEventListener("click", () => {
			if (document.documentElement.dataset.shareEnabled !== "true") {
				return;
			}
			const verseId = verse.id;
			if (!verseId) {
				return;
			}
			if (highlightedIds.includes(verseId)) {
				highlightedIds = highlightedIds.filter((id) => id !== verseId);
			} else {
				highlightedIds = [...highlightedIds, verseId];
			}
			saveHighlights(highlightedIds);
			verse.classList.toggle("highlighted");
			updateShareButton();
		});
		verse.addEventListener("keydown", (event) => {
			if (event.key !== "Enter" && event.key !== " ") {
				return;
			}
			if (document.documentElement.dataset.shareEnabled !== "true") {
				return;
			}
			event.preventDefault();
			verse.click();
		});
	});
});
</script>

<style lang="scss">
	.chapter {
		scroll-margin-top: 3.5em;
		nav {
			ul {
				display: flex;
				flex-wrap: wrap;
				gap: 1rem;
				margin: 1rem 0;
			}
			li {
				font-size: 12px;
			}
		}
		h2 {
			margin: 3rem 0 0 0;
		}
		p {
			position: relative;
			scroll-margin-top: 3.5em;
			&.highlighted {
				outline: 0 none;
				text-decoration-line: underline;
				text-decoration-style: solid;
				text-decoration-thickness: 6px;
				text-decoration-color: var(--accent);
				text-decoration-skip-ink: none;
			}
			&:first-of-type {
				margin-top: 5rem;
				&::first-letter {
					font-size: var(--step-5);
					line-height: 0;
					font-weight: 200;
					margin-right: 5px;
				}
			}
		}
	}
	:global(.share-highlights) {
		position: fixed;
		left: 1.5rem;
		bottom: 1.5rem;
		z-index: 20;
		border: 0 none;
		border-radius: 999px;
		padding: 0.7rem;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		background: var(--text);
		color: var(--bg);
		box-shadow: rgba(0, 0, 0, 0.2) 0 10px 20px;
		cursor: pointer;
	}
	:global(.share-highlights[hidden]) {
		display: none;
	}
</style>
